# ==========================
# Etapa 1: Builder
# ==========================
FROM node:20 AS builder
WORKDIR /app

# Copiar package.json y package-lock.json
COPY package*.json ./

# Limpiar cualquier m칩dulo de Windows y cache
RUN rm -rf node_modules package-lock.json \
 && npm cache clean --force

# Instalar lightningcss para Linux directamente
RUN npm install lightningcss --platform=linux --arch=x64 --force

# Instalar todas las dem치s dependencias
RUN npm ci

# Copiar el c칩digo fuente
COPY . .

# Build de Next.js
RUN npm run build

# ==========================
# Etapa 2: Runner
# ==========================
FROM node:20 AS runner
WORKDIR /app

# Copiar package.json y package-lock.json
COPY package*.json ./

# Instalar solo deps de producci칩n
RUN npm ci --omit=dev

# Copiar build y archivos
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/next.config.* ./

ENV NODE_ENV=production
ENV PORT=3000
EXPOSE 3000

CMD ["npm", "start"]
